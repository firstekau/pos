angular.module("ngTextcomplete",[]).factory("utils",[function(){function e(e){var n,r,i;return n=function(){r=!1},function(){var n=t(arguments);if(r){i=n;return}r=!0;var s=this;n.unshift(function o(){if(i){var t=i;i=undefined,t.unshift(o),e.apply(s,t)}else r=!1}),e.apply(this,n)}}function t(e){return Array.prototype.slice.call(e)}function r(e){var t={};return function(n,r){t[n]?r(t[n]):e.call(this,n,function(e){t[n]=(t[n]||[]).concat(e),r.apply(null,arguments)})}}function i(e,t){var n,r;if(e.indexOf)return e.indexOf(t)!=-1;for(n=0,r=e.length;n<r;n++)if(e[n]===t)return!0;return!1}var n=function(){var e;return e=$("<div></div>").css(["color"]).color,typeof e!="undefined"?function(e,t){return e.css(t)}:function(e,t){var n;return n={},angular.forEach(t,function(t,r){n[t]=e.css(t)}),n}}();return{lock:e,toArray:t,getStyles:n,memoize:r,include:i}}]).factory("Completer",["ListView","utils",function(e,t){function u(e,t){var n;this.el=e.get(0),n=this.el===document.activeElement,this.$el=a(e),this.id="textComplete"+o++,this.strategies=[],n?(this.initialize(),this.$el.focus()):this.$el.one("focus.textComplete",$.proxy(this.initialize,this))}var n,r,i,s,o;n={wrapper:'<div class="textcomplete-wrapper"></div>',list:'<ul class="dropdown-menu"></ul>'},r={wrapper:{position:"relative"},list:{position:"absolute",left:0,zIndex:"100",display:"none"}},i=$(n.wrapper).css(r.wrapper),s=$(n.list).css(r.list),o=0,angular.extend(u.prototype,{initialize:function(){var t,n;t=s.clone(),this.listView=new e(t,this),this.$el.before(t).on({"keyup.textComplete":$.proxy(this.onKeyup,this),"keydown.textComplete":$.proxy(this.listView.onKeydown,this.listView)}),n={},n["click."+this.id]=$.proxy(this.onClickDocument,this),n["keyup."+this.id]=$.proxy(this.onKeyupDocument,this),$(document).on(n)},register:function(e){this.strategies=this.strategies.concat(e)},renderList:function(e){this.clearAtNext&&(this.listView.clear(),this.clearAtNext=!1),e.length&&(this.listView.shown||(this.listView.setPosition(this.getCaretPosition()).clear().activate(),this.listView.strategy=this.strategy),e=e.slice(0,this.strategy.maxCount),this.listView.render(e)),!this.listView.data.length&&this.listView.shown&&this.listView.deactivate()},searchCallbackFactory:function(e){var t=this;return function(n,r){t.renderList(n),r||(e(),t.clearAtNext=!0)}},onKeyup:function(e){var t,n;if(this.skipSearch(e))return;t=this.extractSearchQuery(this.getTextFromHeadToCaret());if(t.length){n=t[1];if(this.term===n)return;this.term=n,this.search(t)}else this.term=null,this.listView.deactivate()},skipSearch:function(e){switch(e.keyCode){case 40:case 38:return!0}if(e.ctrlKey)switch(e.keyCode){case 78:case 80:return!0}},onSelect:function(e){var t,n,r;t=this.getTextFromHeadToCaret(),n=this.el.value.substring(this.el.selectionEnd),r=this.strategy.replace(e),angular.isArray(r)&&(n=r[1]+n,r=r[0]),t=t.replace(this.strategy.match,r),this.$el.val(t+n),$(this).trigger("change").trigger("textComplete:select",this.$el.val()),this.el.focus(),this.el.selectionStart=this.el.selectionEnd=t.length},onClickDocument:function(e){e.originalEvent&&!e.originalEvent.keepTextCompleteDropdown&&this.listView.deactivate()},onKeyupDocument:function(e){this.listView.shown&&e.keyCode===27&&(this.listView.deactivate(),this.$el.focus())},destroy:function(){var e;this.$el.off(".textComplete"),$(document).off("."+this.id),this.listView&&this.listView.destroy(),e=this.$el.parent(),e.after(this.$el).remove(),this.$el.data("textComplete",void 0),this.$el=null},getCaretPosition:function(){var e,n,r,i,s,o,u;return o=this.$el.attr("dir")||this.$el.css("direction"),e=["border-width","font-family","font-size","font-style","font-variant","font-weight","height","letter-spacing","word-spacing","line-height","text-decoration","text-align","width","padding-top","padding-right","padding-bottom","padding-left","margin-top","margin-right","margin-bottom","margin-left","border-style","box-sizing"],u=this.$el[0].scrollHeight>this.$el[0].offsetHeight,n=$.extend({position:"absolute",overflow:u?"scroll":"auto","white-space":"pre-wrap",top:0,left:-9999,direction:o},t.getStyles(this.$el,e)),r=$("<div></div>").css(n).text(this.getTextFromHeadToCaret()),i=$("<span></span>").text(".").appendTo(r),this.$el.before(r),s=i.position(),s.top+=i.height()-this.$el.scrollTop(),o=="rtl"&&(s.left-=this.listView.$el.width()),r.remove(),s},getTextFromHeadToCaret:function(){var e,t,n;return t=this.el.selectionEnd,typeof t=="number"?e=this.el.value.substring(0,t):document.selection&&(n=this.el.createTextRange(),n.moveStart("character",0),n.moveEnd("textedit"),e=n.text),e},extractSearchQuery:function(e){var t,n,r,i;for(t=0,n=this.strategies.length;t<n;t++){r=this.strategies[t],i=e.match(r.match);if(i)return[r,i[r.index]]}return[]},search:t.lock(function(e,t){var n;this.strategy=t[0],n=t[1],this.strategy.search(n,this.searchCallbackFactory(e))})});var a=function(e){return e.wrap(i.clone().css("display",e.css("display")))};return u}]).factory("ListView",["utils",function(e){function t(e,t){this.data=[],this.$el=e,this.index=0,this.completer=t,this.$el.on("click.textComplete","li.textcomplete-item",$.proxy(this.onClick,this))}return angular.extend(t.prototype,{shown:!1,render:function(t){var n,r,i,s,o;n="";for(r=0,i=t.length;r<i;r++){o=t[r];if(e.include(this.data,o))continue;s=this.data.length,this.data.push(o),n+='<li class="textcomplete-item" data-index="'+s+'"><a>',n+=this.strategy.template(o),n+="</a></li>";if(this.data.length===this.strategy.maxCount)break}this.$el.append(n),this.data.length?this.activateIndexedItem():this.deactivate()},clear:function(){return this.data=[],this.$el.html(""),this.index=0,this},activateIndexedItem:function(){this.$el.find(".active").removeClass("active"),this.getActiveItem().addClass("active")},getActiveItem:function(){return $(this.$el.children().get(this.index))},activate:function(){return this.shown||(this.$el.show(),$(this).trigger("textComplete:show"),this.shown=!0),this},deactivate:function(){return this.shown&&(this.$el.hide(),$(this).trigger("textComplete:show"),this.shown=!1,this.data=[],this.index=null),this},setPosition:function(e){var t;return this.completer.strategy.placement==="top"?(t=parseInt(this.$el.css("font-size")),e={top:"auto",bottom:this.$el.parent().height()-e.top+t}):e.bottom="auto",this.$el.parent().offset().left+e.left+this.$el.width()>$(window).width()?(e.right=this.$el.parent().width()-e.left,e.left="auto"):e.right="auto",this.$el.css(e),this},select:function(e){var t=this;this.completer.onSelect(this.data[e]),setTimeout(function(){t.deactivate()},0)},onKeydown:function(e){if(!this.shown)return;if(e.keyCode===27)this.deactivate();else if(e.keyCode===38||e.ctrlKey&&e.keyCode===80)e.preventDefault(),this.index===0?this.index=this.data.length-1:this.index-=1,this.activateIndexedItem();else if(e.keyCode===40||e.ctrlKey&&e.keyCode===78)e.preventDefault(),this.index===this.data.length-1?this.index=0:this.index+=1,this.activateIndexedItem();else if(e.keyCode===13||e.keyCode===9)e.preventDefault(),this.select(parseInt(this.getActiveItem().data("index"),10))},onClick:function(e){var t=$(e.target);e.originalEvent.keepTextCompleteDropdown=!0,t.hasClass("textcomplete-item")||(t=t.parents("li.textcomplete-item")),this.select(parseInt(t.data("index"),10))},destroy:function(){this.deactivate(),this.$el.off("click.textComplete").remove(),this.$el=null}}),t}]).factory("Textcomplete",["utils","Completer",function(e,t){function n(e){return e}function r(e,r){var i,s,o,u;u="textComplete";if(r==="destroy")return this.each(function(){var e=$(this).data(u);e&&e.destroy()});for(i=0,s=r.length;i<s;i++)o=r[i],o.template||(o.template=n),o.index==null&&(o.index=2),o.cache&&(o.search=memoize(o.search)),o.maxCount||(o.maxCount=10);var a;return a=e.data(u),a||(a=new t(e),e.data(u,a)),a.register(r),$(a)}return r}]);