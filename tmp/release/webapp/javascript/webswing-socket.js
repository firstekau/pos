webswingRequirejs.define(["atmosphere","ProtoBuf","jquery","text!webswing.proto"],function(t,n,r,i){var s=n.loadProto(i,"webswing.proto"),o=s.build("org.webswing.server.model.proto.InputEventsFrameMsgInProto"),u=s.build("org.webswing.server.model.proto.AppFrameMsgOutProto");return function(){function c(){var e={url:i.cfg.connectionUrl+"async/swing",contentType:"application/json",transport:"websocket",trackMessageLength:!0,reconnectInterval:5e3,fallbackTransport:"long-polling",enableXDR:!0,headers:{}};f&&(e.url=e.url+"-bin",e.headers["X-Atmosphere-Binary"]=!0,e.enableProtocol=!1,e.trackMessageLength=!1,e.contentType="application/octet-stream",e.webSocketBinaryType="arraybuffer"),i.cfg.recordingPlayback&&(e.url=i.cfg.connectionUrl+"playback/async/swing-play",e.headers.file=i.cfg.recordingPlayback),i.cfg.args!=null&&(e.headers["X-webswing-args"]=i.cfg.args),i.cfg.recording!=null&&(e.headers["X-webswing-recording"]=i.cfg.recording),i.cfg.debugPort!=null&&(e.headers["X-webswing-debugPort"]=i.cfg.debugPort),e.onOpen=function(e){e.transport!=="websocket"&&(f?(console.error("Webswing: Binary encoding not supported for "+e.transport+" transport. Falling back to json encoding."),i.cfg.binarySocket=!1,f=!1,p(),c()):i.showBar(i.longPollingWarningDialog))},e.onReopen=function(e){i.hideDialog()},e.onMessage=function(e){var t=(new Date).getTime();try{var n=h(e);n.sessionId!=null&&(a=n.sessionId);if(n.javaResponse!=null&&n.javaResponse.correlationId!=null){var r=n.javaResponse.correlationId;if(l[r]!=null){var s=l[r];delete l[r],s(n.javaResponse)}}n.receivedTimestamp=t,i.processMessage(n)}catch(o){console.error(o.stack);return}},e.onClose=function(e){i.currentDialog()!==i.stoppedDialog&&i.currentDialog()!==i.timedoutDialog&&i.showDialog(i.disconnectedDialog)},e.onError=function(e){i.showDialog(i.connectionErrorDialog)},r.ajax({xhrFields:{withCredentials:!0},type:"GET",url:i.cfg.connectionUrl+"rest/CSRFToken",success:function(n){e.headers["X-webswing-CSRFToken"]=n,s=t.subscribe(e)},error:function(e){i.showDialog(i.connectionErrorDialog),console.error("CSRF Token validation failed.")}})}function h(e){var n=e.responseBody,r;if(f){if(n.byteLength===1)return{};r=u.decode(n),g(r)}else r=t.util.parseJSON(n);return r}function p(){t.unsubscribe(s),s=null,a=null}function d(e){if(s!=null)if(s.request.isOpen&&!s.request.closed)if(typeof e=="object")if(f){var n=new o(e);s.push(n.encode().toArrayBuffer())}else s.push(t.util.stringifyJSON(e));else console.log("message is not an object "+e);else i.showDialog(i.disconnectedDialog)}function v(e,t,n,r){d(t),l[n]=e,setTimeout(function(){l[n]!=null&&(delete l[n],e(new Error("Java call timed out after "+r+" ms.")))},r)}function m(){return a}function g(e){e!=null&&(Array.isArray(e)?e.forEach(function(e){g(e)}):e.$type._fields.forEach(function(t){if(t.resolvedType!=null)if(t.resolvedType.className==="Enum"){var n=t.resolvedType.object;for(var r in n)n[r]===e[t.name]&&(e[t.name]=r)}else t.resolvedType.className==="Message"&&g(e[t.name])}))}var n=this,i;n.injects=i={cfg:"webswing.config",processMessage:"base.processMessage",showDialog:"dialog.show",showBar:"dialog.showBar",hideDialog:"dialog.hide",currentDialog:"dialog.current",stoppedDialog:"dialog.content.stoppedDialog",disconnectedDialog:"dialog.content.disconnectedDialog",timedoutDialog:"dialog.content.timedoutDialog",connectionErrorDialog:"dialog.content.connectionErrorDialog",initializingDialog:"dialog.content.initializingDialog",longPollingWarningDialog:"dialog.content.longPollingWarningDialog"},n.provides={connect:c,send:d,uuid:m,awaitResponse:v,dispose:p},n.ready=function(){f=i.cfg.typedArraysSupported&&i.cfg.binarySocket};var s,a,f,l={}}});