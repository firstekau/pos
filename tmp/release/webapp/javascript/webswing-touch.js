webswingRequirejs.define(["jquery","text!templates/touch.html","webswing-util","hammer"],function(t,n,r,i){return function(){function h(){if(!c){var e=o.getCanvas();u=new i(e,{touchAction:"manipulation"}),u.get("tap").set({threshold:4}),u.on("tap",function(t){if(t.pointerType==="touch"){var n=d(e,t,1);o.send(n),v(),e.focus()}}),u.on("press",function(t){if(t.pointerType==="touch"){var n=d(e,t,3);o.send(n)}}),c=!0}}function p(e){e.value=" ",e.focus(),e.select()}function d(e,t,n){function o(e){return{mouse:{x:i,y:s,type:e,button:n,buttons:n==1?2:8}}}var r=e.getBoundingClientRect(),i=Math.round(t.center.x-r.left),s=Math.round(t.center.y-r.top);return{events:[o("mousedown"),o("mouseup")]}}function v(){a!=null&&g(),o.cfg.rootElement.append(n),a=o.cfg.rootElement.find('div[data-id="touchBar"]'),a.find('button[data-id="kbdBtn"]').on("click",function(e){o.cfg.virtualKB=!0,p(o.getInput()),g(),t(o.getInput()).on("input compositionstart compositionupdate compositionend",m),t(o.getInput()).on("blur",function(e){o.cfg.virtualKB=!1,t(o.getInput()).off("compositionstart compositionupdate compositionend")})}),a.show("fast")}function m(e){e.type==="compositionstart"&&(f=e.originalEvent.data,l=!0);if(e.type==="compositionupdate"||e.type==="compositionend"){var t=e.originalEvent.data;t.indexOf(f)==0?y(t.substring(f.length)):(b(f.length),y(t)),f=t}e.type==="compositionend"&&(f="",setTimeout(function(){e.currentTarget.value="",l=!1},0));if(e.type==="input"&&!l){var t=e.originalEvent.target.value;y(t),e.currentTarget.value=""}}function g(){a!=null&&(a.hide("fast"),a.remove(),a=null)}function y(e){for(var t=0,n=e.length;t<n;t++){var r=0;r=e.charCodeAt(t),o.send({events:[w("keydown",r),w("keypress",r),w("keyup",r)]})}}function b(e){var t=[];for(var n=0;n<e;n++)t.push(w("keydown",8,8)),t.push(w("keyup",8,8));o.send({events:t})}function w(e,t,n){return{key:{type:e,character:t,keycode:n!=null?n:0,alt:!1,ctrl:!1,shift:!1,meta:!1}}}function E(){g(),u=null,f="",l=!1,c=!1}var s=this,o;s.injects=o={cfg:"webswing.config",send:"socket.send",getInput:"canvas.getInput",getCanvas:"canvas.get"},s.provides={register:h,dispose:E},s.ready=function(){r.preventGhosts(o.cfg.rootElement)};var u,a,f="",l=!1,c=!1}});